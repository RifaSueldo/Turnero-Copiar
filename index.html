<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agregar Horarios</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input, select, button { margin: 5px 0; padding: 5px; }
  .bloque { margin-bottom: 10px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; }
</style>
</head>
<body>
<h1>Agregar Horarios de Profesionales</h1>

<label>Profesional:</label>
<input type="text" id="profesional" placeholder="Ej: Pepe"><br><br>

<div id="bloques-container"></div>

<button type="button" onclick="agregarBloque()">+ Agregar bloque</button><br><br>
<button type="button" onclick="enviarTurnos()">Enviar turnos</button>

<p id="mensaje"></p>

<script>
const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbxwhEWjvO7KaMXywRnjROuqtgRJaQSA4AtdnEmtd-gagh-KANDDIwlOaRB4sl-_VfuU6w/exec"; // reemplazá con tu URL de Web App

// Agrega un bloque de horario
function agregarBloque() {
  const container = document.getElementById("bloques-container");
  const div = document.createElement("div");
  div.className = "bloque";

  const select = document.createElement("select");
  select.className = "dia";
  ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"].forEach(d=>{
    const option = document.createElement("option");
    option.value = d;
    option.textContent = d;
    select.appendChild(option);
  });

  const inicio = document.createElement("input");
  inicio.type = "time";
  inicio.className = "inicio";

  const fin = document.createElement("input");
  fin.type = "time";
  fin.className = "fin";

  const btnQuitar = document.createElement("button");
  btnQuitar.type = "button";
  btnQuitar.textContent = "Quitar";
  btnQuitar.onclick = () => div.remove();

  div.appendChild(select);
  div.appendChild(inicio);
  div.appendChild(fin);
  div.appendChild(btnQuitar);
  container.appendChild(div);
}

// Genera los turnos de 30 min para un bloque
function generarTurnosDeBloque(profesional, dia, inicio, fin) {
  const turnos = [];
  const [hInicio, mInicio] = inicio.split(":").map(Number);
  const [hFin, mFin] = fin.split(":").map(Number);

  let start = hInicio * 60 + mInicio;
  const end = hFin * 60 + mFin;

  while(start <= end) {
    const hora = `${Math.floor(start/60).toString().padStart(2,"0")}:${(start%60).toString().padStart(2,"0")}`;
    turnos.push({profesional, dia, hora, disponible: "Sí"});
    start += 30;
  }
  return turnos;
}

// Enviar todos los bloques y turnos al Apps Script
async function enviarTurnos() {
  const profesional = document.getElementById("profesional").value.trim();
  if(!profesional) return alert("Ingresá el nombre del profesional");

  const bloques = document.querySelectorAll(".bloque");
  if(bloques.length === 0) return alert("Agregá al menos un bloque");

  let todosTurnos = [];
  let horarios = [];

  bloques.forEach(div => {
    const dia = div.querySelector(".dia").value;
    const inicio = div.querySelector(".inicio").value;
    const fin = div.querySelector(".fin").value;
    if(inicio && fin) {
      horarios.push({dia, inicio, fin});
      todosTurnos = todosTurnos.concat(generarTurnosDeBloque(profesional, dia, inicio, fin));
    }
  });

  try {
    const res = await fetch(URL_APPS_SCRIPT, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({profesional, horarios, turnos: todosTurnos})
    });

    const data = await res.json();
    if(data.status === "ok") {
      document.getElementById("mensaje").innerText = "✅ Turnos enviados correctamente!";
      document.getElementById("bloques-container").innerHTML = "";
      document.getElementById("profesional").value = "";
    } else {
      document.getElementById("mensaje").innerText = "⚠️ Error: " + data.message;
    }
  } catch(err) {
    document.getElementById("mensaje").innerText = "❌ Error al enviar: " + err;
    console.error(err);
  }
}

// Agrega un bloque por defecto
agregarBloque();
</script>
</body>
</html>
